#!/bin/bash

set -e

cd "$(dirname "$0")/.."

if [ ! -f conf/general.yml ]; then
    sed -r \
        -e "s,^( *FMS_DB_HOST:).*,\\1 'postgres.svc'," \
        -e "s,^( *FMS_DB_NAME:).*,\\1 'fixmystreet'," \
        -e "s,^( *FMS_DB_USER:).*,\\1 'postgres'," \
        -e "s,^( *FMS_DB_PASS:).*,\\1 'password'," \
        -e "s,^( *BASE_URL:).*,\\1 'http://127.0.0.1.nip.io:3000'," \
        -e "s,^( *MAPIT_URL:).*,\\1 'http://localhost:3000/fakemapit/'," \
        -e "s,^( *MEMCACHED_HOST:).*,\\1 'memcached.svc'," \
        -e "s,^( *SMTP_SMARTHOST:).*,\\1 'email.svc'," \
        -e "s,^( *SMTP_PORT:).*,\\1 '1025'," \
        conf/general.yml-example > conf/general.yml
fi

# Install required locales for multi-language support
if command -v locale-gen &>/dev/null; then
    locale-gen en_GB.UTF-8 tr_TR.UTF-8 es_ES.UTF-8 ru_RU.UTF-8
fi

script/update --development
bin/update-all-reports

# Install cron job to regenerate dashboard cache hourly, low priority
cat > /etc/cron.d/fixmystreet-dashboard << 'CRON'
# Regenerate dashboard cache hourly, low priority
0 * * * * root cd /var/www/fixmystreet && nice -n 19 ionice -c 3 bin/update-all-reports > /dev/null 2>&1
CRON
chmod 644 /etc/cron.d/fixmystreet-dashboard
service cron start || true
