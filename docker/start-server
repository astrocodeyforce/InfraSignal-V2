#!/bin/bash
# Start cron for background dashboard cache updates, then launch the app server.

# Install the cron job for dashboard cache regeneration (hourly, low priority)
cat > /etc/cron.d/fixmystreet-dashboard << 'CRON'
# Regenerate dashboard cache hourly, low priority
0 * * * * root cd /var/www/fixmystreet && nice -n 19 ionice -c 3 bin/update-all-reports > /dev/null 2>&1
CRON
chmod 644 /etc/cron.d/fixmystreet-dashboard

# Start cron daemon
service cron start 2>/dev/null || true

# Launch the app server (pass through any arguments like --listen :3000)
exec script/server "$@"
