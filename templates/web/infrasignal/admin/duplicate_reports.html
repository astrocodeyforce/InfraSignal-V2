[% INCLUDE 'admin/header.html' title=loc('Duplicate Reports') %]

<style>
.dup-filters { background: #f5f5f0; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
.dup-filters label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 3px; }
.dup-filters select, .dup-filters input[type=number] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
.dup-filters button { padding: 7px 18px; background: #ffd000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; }
.dup-filters button:hover { background: #eec100; }
.dup-stats { display: flex; gap: 20px; margin-bottom: 20px; }
.dup-stat { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px 20px; text-align: center; }
.dup-stat .num { font-size: 28px; font-weight: bold; color: #e74c3c; }
.dup-stat .lbl { font-size: 12px; color: #666; }
.dup-group { background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
.dup-group-header { background: #fef3cd; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
.dup-group-header .badge { background: #e74c3c; color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
.dup-group-header .dist { color: #666; font-size: 13px; }
.dup-group-header .cat { font-weight: bold; color: #333; }
.dup-reports { display: flex; flex-wrap: wrap; gap: 0; }
.dup-report { flex: 1; min-width: 280px; padding: 12px 15px; border-right: 1px solid #eee; position: relative; }
.dup-report:last-child { border-right: none; }
.dup-report .report-id { font-weight: bold; color: #0056b3; }
.dup-report .report-id a { color: #0056b3; text-decoration: none; }
.dup-report .report-id a:hover { text-decoration: underline; }
.dup-report .report-title { font-size: 14px; margin: 4px 0; }
.dup-report .report-meta { font-size: 12px; color: #666; }
.dup-report .report-detail { font-size: 12px; color: #444; margin-top: 5px; max-height: 60px; overflow: hidden; }
.dup-report .report-state { display: inline-block; padding: 1px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; }
.dup-report .report-state.confirmed { background: #d4edda; color: #155724; }
.dup-report .report-state.investigating { background: #cce5ff; color: #004085; }
.dup-report .report-state.fixed { background: #e2e3e5; color: #383d41; }
.dup-report .report-state.duplicate { background: #f8d7da; color: #721c24; }
.dup-report .report-photo { margin-top: 6px; }
.dup-report .report-photo img { max-width: 120px; max-height: 80px; border-radius: 4px; border: 1px solid #ddd; }
.dup-actions { padding: 8px 15px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
.dup-actions select { padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 3px; }
.dup-actions button { padding: 4px 14px; font-size: 12px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; }
.dup-actions .btn-mark { background: #e74c3c; color: #fff; }
.dup-actions .btn-mark:hover { background: #c0392b; }
.dup-actions .btn-dismiss { background: #6c757d; color: #fff; }
.dup-actions .btn-dismiss:hover { background: #5a6268; }
.dup-arrow { font-size: 24px; color: #e74c3c; align-self: center; padding: 0 5px; flex-shrink: 0; }
.empty-state { text-align: center; padding: 40px; color: #666; }
.empty-state .icon { font-size: 48px; margin-bottom: 10px; }
</style>

<h1>[% loc('Duplicate Reports') %]</h1>
<p style="color:#666;margin-top:-5px;margin-bottom:15px;">
    [% loc('Reports in the same category within a geographic radius that may be duplicates.') %]
</p>

<!-- Filters -->
<form method="get" class="dup-filters">
    <div>
        <label>[% loc('Radius (metres)') %]</label>
        <input type="number" name="radius" value="[% radius || 500 %]" min="50" max="2000" step="50" style="width:100px;">
    </div>
    <div>
        <label>[% loc('Category') %]</label>
        <select name="category">
            <option value="">[% loc('All Categories') %]</option>
            [% FOREACH cat IN categories %]
            <option value="[% cat | html %]" [% IF category_filter == cat %]selected[% END %]>[% cat | html %]</option>
            [% END %]
        </select>
    </div>
    <div>
        <label>[% loc('Report State') %]</label>
        <select name="state">
            <option value="" [% IF !state_filter OR state_filter == '' %]selected[% END %]>[% loc('Open only') %]</option>
            <option value="all" [% IF state_filter == 'all' %]selected[% END %]>[% loc('All states') %]</option>
            <option value="confirmed" [% IF state_filter == 'confirmed' %]selected[% END %]>[% loc('Confirmed') %]</option>
            <option value="investigating" [% IF state_filter == 'investigating' %]selected[% END %]>[% loc('Investigating') %]</option>
        </select>
    </div>
    <div>
        <button type="submit">[% loc('Filter') %]</button>
    </div>
</form>

<!-- Stats -->
<div class="dup-stats">
    <div class="dup-stat">
        <div class="num">[% total_groups || 0 %]</div>
        <div class="lbl">[% loc('Duplicate Groups') %]</div>
    </div>
    <div class="dup-stat">
        <div class="num">[% total_pairs || 0 %]</div>
        <div class="lbl">[% loc('Report Pairs') %]</div>
    </div>
    <div class="dup-stat">
        <div class="num">[% radius || 500 %]m</div>
        <div class="lbl">[% loc('Detection Radius') %]</div>
    </div>
</div>

<!-- Duplicate Groups -->
[% IF duplicate_groups.size %]
    [% FOREACH group IN duplicate_groups %]
    <div class="dup-group">
        <div class="dup-group-header">
            <div>
                <span class="cat">[% group.category | html %]</span>
                <span class="dist">&mdash; [% group.min_distance %]m apart</span>
            </div>
            <span class="badge">[% group.count %] [% loc('reports') %]</span>
        </div>
        <div class="dup-reports">
            [% FOREACH report IN group.reports %]
                [% IF !loop.first %]<div class="dup-arrow">&#8596;</div>[% END %]
                <div class="dup-report">
                    <div class="report-id">
                        <a href="[% c.uri_for('/admin/report_edit', report.id) %]">#[% report.id %]</a>
                        <span class="report-state [% report.state | replace(' ', '-') %]">[% report.state | html %]</span>
                    </div>
                    <div class="report-title">[% report.title.substr(0, 60) | html %][% IF report.title.length > 60 %]&hellip;[% END %]</div>
                    <div class="report-meta">
                        [% report.created.substr(0, 19) %] &bull;
                        [% report.latitude %], [% report.longitude %]
                    </div>
                    <div class="report-detail">[% report.detail.substr(0, 120) | html %][% IF report.detail.length > 120 %]&hellip;[% END %]</div>
                    [% IF report.has_photo %]
                    <div class="report-photo">
                        <img src="/photo/[% report.id %].0.fp.jpeg" alt="Report photo" loading="lazy">
                    </div>
                    [% END %]
                </div>
            [% END %]
        </div>
        <div class="dup-actions">
            <form method="post" action="[% c.uri_for('/admin/duplicate_reports/mark') %]" style="display:flex;gap:8px;align-items:center;">
                <input type="hidden" name="token" value="[% csrf_token %]">
                <label style="font-size:12px;font-weight:bold;">[% loc('Mark as duplicate:') %]</label>
                <select name="report_id" style="font-size:12px;">
                    [% FOREACH report IN group.reports %]
                    <option value="[% report.id %]" [% IF loop.last %]selected[% END %]>#[% report.id %] - [% report.title.substr(0, 30) | html %]</option>
                    [% END %]
                </select>
                <span style="font-size:12px;color:#666;">[% loc('is duplicate of') %]</span>
                <select name="duplicate_of" style="font-size:12px;">
                    [% FOREACH report IN group.reports %]
                    <option value="[% report.id %]" [% IF loop.first %]selected[% END %]>#[% report.id %] - [% report.title.substr(0, 30) | html %]</option>
                    [% END %]
                </select>
                <button type="submit" class="btn-mark">[% loc('Mark') %]</button>
            </form>
            <form method="post" action="[% c.uri_for('/admin/duplicate_reports/dismiss') %]" style="margin-left:auto;">
                <input type="hidden" name="token" value="[% csrf_token %]">
                <input type="hidden" name="report_ids" value="[% group.report_ids %]">
                <button type="submit" class="btn-dismiss">[% loc('Dismiss') %]</button>
            </form>
        </div>
    </div>
    [% END %]
[% ELSE %]
    <div class="empty-state">
        <div class="icon">&#10004;</div>
        <h3>[% loc('No duplicate reports detected') %]</h3>
        <p>[% loc('No reports found within the specified radius sharing the same category. Try increasing the radius.') %]</p>
    </div>
[% END %]

[% INCLUDE 'admin/footer.html' %]
